{"meta":{"title":"フルスクラッチでSHA-256を作る","date":"2021-01-08","category":"Algorithm","description":"TypeScriptで実装する","ogp":"/media/sha256.webp"},"body":"<p>ハッシュ値の利用者として中身のアルゴリズムを知っておきたいと思ったのでTypeScriptで1からSHA-256を作ろうと思います。SHA-256は名前そのまま、どんな長さのメッセージでも256bitsのハッシュ値を返す関数です。</p>\n<p>完成版はこちら<br>\n<a href=\"https://github.com/kota-yata/organic-sha256\">https://github.com/kota-yata/organic-sha256</a></p>\n<div class=\"message\">\nこの実装はのちに記載する仕様の論文に沿って純粋に記述しています。セキュリティ的にも速度的にも、プロジェクトでハッシュ関数を用いる際は既存のライブラリを使用することをおすすめします\n</div>\n<h2>前提知識</h2>\n<p>論理演算（論理積とか論理和とか排他的論理和とか）とシフト演算が分かっていれば大体いけます。</p>\n<p>論理積はAND。数式上では<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>∧</mo></mrow><annotation encoding=\"application/x-tex\">\\land</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5556em;\"></span><span class=\"mord\">∧</span></span></span></span></eq>、コードでは<code>&amp;</code>で表します。<br>\n論理和はOR。数式上では<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>∨</mo></mrow><annotation encoding=\"application/x-tex\">\\lor</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5556em;\"></span><span class=\"mord\">∨</span></span></span></span></eq>、コードでは<code>|</code>で表します。<br>\n排他的論理和はXOR。数式上では$\\oplus$、コードでは<code>^</code>で表します。</p>\n<p>左シフト演算はビット列を左にnビット動かすやつです。値は<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>2</mn><mi>n</mi></msup></mrow><annotation encoding=\"application/x-tex\">2^n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6644em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6644em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span></span></span></span></span></span></span></span></eq>倍になります。数式上では<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>≪</mo></mrow><annotation encoding=\"application/x-tex\">\\ll</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5782em;vertical-align:-0.0391em;\"></span><span class=\"mrel\">≪</span></span></span></span></eq>、コードでは<code>&lt;&lt;</code>で表します。<br>\n右シフト演算はビット列を右にnビット動かすやつです。値は<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mn>2</mn><mrow><mo>−</mo><mi>n</mi></mrow></msup></mrow><annotation encoding=\"application/x-tex\">2^{-n}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7713em;\"></span><span class=\"mord\"><span class=\"mord\">2</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7713em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">−</span><span class=\"mord mathnormal mtight\">n</span></span></span></span></span></span></span></span></span></span></span></span></eq>倍になります。数式上では<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mo>≫</mo></mrow><annotation encoding=\"application/x-tex\">\\gg</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5782em;vertical-align:-0.0391em;\"></span><span class=\"mrel\">≫</span></span></span></span></eq>、コードでは符号なしの右シフト演算を使用するので<code>&gt;&gt;&gt;</code>で表します。</p>\n<h2>下準備</h2>\n<p>SHA256のハッシュ関数ではメッセージを512bitsのブロックに分けてハッシュ値を算出します。その際に余りや不足が出ては困るので、プリプロセスとして平文のPadding処理を行います。</p>\n<h3>Padding関数</h3>\n<p>このPadding処理ではメッセージを512bitsの倍数にして返します。実際の実装ではbyte単位で考えるので512bits = 64byte、64の倍数に拡張して返すという処理になります。</p>\n<h5>手順</h5>\n<p>具体的にはメッセージの末尾に<code>0x80(bit単位の1)</code>を加え、残りをメッセージのサイズを表すbyte列と0で埋めるという関数を書くことになります。メッセージサイズを表すbyte列は8bytesで、64bytesからその8bytesを引き、メッセージ分のbyteと<code>0x80</code>の1byteを引いた残りのbyteは0で埋めます。</p>\n<h5>実装</h5>\n<p>padding関数ではメッセージの文字列を引数にとって、64bytesの倍数にした16進数のbyte列を文字列の型で返すものです。</p>\n<pre><code class=\"language-typescript\"><span class=\"hljs-keyword\">let</span> <span class=\"hljs-attr\">sizeLastBlock</span>: <span class=\"hljs-built_in\">number</span> = <span class=\"hljs-number\">64</span>; <span class=\"hljs-comment\">// Mの末尾のブロックサイズ</span>\n<span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">sizeMLengthBuffer</span>: <span class=\"hljs-built_in\">number</span> = <span class=\"hljs-number\">8</span>; <span class=\"hljs-comment\">// 最終的なメッセージの末尾8bytesはMのサイズを記述する</span>\n<span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">sizeDivision</span>: <span class=\"hljs-built_in\">number</span> = <span class=\"hljs-number\">1</span>; <span class=\"hljs-comment\">// メッセージバイトと余りの0byteの区切り（0x80）</span>\n<span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">sizeMaxBlock</span>: <span class=\"hljs-built_in\">number</span> = sizeLastBlock - sizeMLengthBuffer - sizeDivision; <span class=\"hljs-comment\">// メッセージバイトは55bytes以下であれば良い</span>\n</code></pre>\n<p>ここは上で説明したサイズをbyteで表したものです。最後の<code>sizeMaxBlock</code>は、メッセージを入れられるbyte数を算出しています。</p>\n<pre><code class=\"language-typescript\"><span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">sizeM</span>: <span class=\"hljs-built_in\">number</span> = <span class=\"hljs-built_in\">encodeURI</span>(M).<span class=\"hljs-title function_\">replace</span>(<span class=\"hljs-regexp\">/%../g</span>, <span class=\"hljs-string\">&quot;*&quot;</span>).<span class=\"hljs-property\">length</span>;\n</code></pre>\n<p>ここではメッセージのbyte数を取得しています。<code>M.length</code>だと全角文字や絵文字の場合正確に取得できないため一度UTF-8でエンコードして長さを測ります。</p>\n<pre><code class=\"language-typescript\"><span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">sizeLastM</span>: <span class=\"hljs-built_in\">number</span> = sizeM % <span class=\"hljs-number\">64</span>;\n<span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">isOverflow</span>: <span class=\"hljs-built_in\">boolean</span> = sizeMaxBlock &lt; sizeLastM;\n\n<span class=\"hljs-keyword\">if</span> (isOverflow) sizeLastBlock = <span class=\"hljs-number\">128</span>; <span class=\"hljs-comment\">// Mの最後のブロックのバイトサイズが55bytesを超えていると1ブロックに格納できないため１ブロック追加する</span>\n</code></pre>\n<p>最後のブロックは末尾にメッセージサイズのバイトと区切りの<code>0x80</code>が入るので<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>64</mn><mo>−</mo><mn>8</mn><mo>−</mo><mn>1</mn><mo>=</mo><mn>55</mn></mrow><annotation encoding=\"application/x-tex\">64-8-1=55</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">64</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7278em;vertical-align:-0.0833em;\"></span><span class=\"mord\">8</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">55</span></span></span></span></eq>bytesになります。なので64bytesに切り刻んだ最後のブロックが<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>55</mn><mo>&lt;</mo><mi>x</mi><mo>≤</mo><mn>64</mn></mrow><annotation encoding=\"application/x-tex\">55 &lt; x \\le 64</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6835em;vertical-align:-0.0391em;\"></span><span class=\"mord\">55</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">&lt;</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7719em;vertical-align:-0.136em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≤</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">64</span></span></span></span></eq>bytesだった場合、もう一つブロックを増やす=最後のブロックを128bytesにしておく必要があります。</p>\n<pre><code class=\"language-typescript\"><span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">hexStringM</span>: <span class=\"hljs-built_in\">string</span> = <span class=\"hljs-title class_\">Array</span>.<span class=\"hljs-title function_\">from</span>((<span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">TextEncoder</span>()).<span class=\"hljs-title function_\">encode</span>(M)).<span class=\"hljs-title function_\">map</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">v</span> =&gt;</span> v.<span class=\"hljs-title function_\">toString</span>(<span class=\"hljs-number\">16</span>)).<span class=\"hljs-title function_\">join</span>(<span class=\"hljs-string\">&quot;&quot;</span>);\n</code></pre>\n<p>文字列を16進数に変換しています。一回メッセージをUTF-8でエンコードし、それを一文字ずつ16進数文字列に変換しています。</p>\n<pre><code class=\"language-typescript\"><span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">sizeExtra</span>: <span class=\"hljs-built_in\">number</span> = (sizeLastBlock - sizeMLengthBuffer - sizeDivision - sizeLastM) * <span class=\"hljs-number\">2</span>;\n<span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">hexExtraString</span>: <span class=\"hljs-built_in\">string</span> = <span class=\"hljs-title class_\">Array</span>(sizeExtra).<span class=\"hljs-title function_\">fill</span>(<span class=\"hljs-number\">0</span>).<span class=\"hljs-title function_\">join</span>(<span class=\"hljs-string\">&quot;&quot;</span>);\n</code></pre>\n<p>0を入れる余りのbyte数を<code>sizeExtra</code>に代入し、<code>hexExtraString</code>に実際の文字列を入れています。<code>sizeExtra</code>の最後で2倍しているのは、のちに文字列を16進数の数値に変換した際に1文字の0だとその次の0と結合して16進数の<code>0x00</code>が生成されてしまうためです。</p>\n<pre><code class=\"language-typescript\"><span class=\"hljs-keyword\">const</span> hexSizeM : <span class=\"hljs-built_in\">string</span>= (sizeM * <span class=\"hljs-number\">8</span>).<span class=\"hljs-title function_\">toString</span>(<span class=\"hljs-number\">16</span>);\n<span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">hex8bytesLengthM</span>: <span class=\"hljs-built_in\">string</span> = <span class=\"hljs-title class_\">Array</span>(<span class=\"hljs-number\">16</span> - hexSizeM.<span class=\"hljs-property\">length</span>).<span class=\"hljs-title function_\">fill</span>(<span class=\"hljs-number\">0</span>).<span class=\"hljs-title function_\">concat</span>(hexSizeM).<span class=\"hljs-title function_\">join</span>(<span class=\"hljs-string\">&quot;&quot;</span>);\n</code></pre>\n<p>メッセージの末尾に挿入するメッセージサイズの8bytesを生成しています。<code>hexSizeM</code>にサイズを表す16進数文字列を代入し、<code>hex8bytesLengthM</code>で8bytes内で使われなかったbytesに加える0と<code>hexSizeM</code>を結合しています。</p>\n<pre><code class=\"language-typescript\"><span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">resultString</span>: <span class=\"hljs-built_in\">string</span> = hexStringM + <span class=\"hljs-string\">&quot;80&quot;</span> + hexExtraString + hex8bytesLengthM;\n</code></pre>\n<p>最終的に戻り値となる文字列を生成しています。</p>\n<h3>Divide関数</h3>\n<p>Padding処理によって64bytesの倍数になったメッセージを、64bytesごとに切り分けます。わざわざ関数に分けるほどでもありませんがPreprocessなので一応。</p>\n<pre><code class=\"language-typescript\"><span class=\"hljs-keyword\">const</span> divideM = (<span class=\"hljs-attr\">M</span>: <span class=\"hljs-built_in\">string</span>): <span class=\"hljs-built_in\">string</span>[] =&gt; {\n  <span class=\"hljs-comment\">// 文字列として扱っているので64bytesは128文字</span>\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">arrayM</span>: <span class=\"hljs-title class_\">RegExpMatchArray</span> | <span class=\"hljs-literal\">null</span> = M.<span class=\"hljs-title function_\">match</span>(<span class=\"hljs-regexp\">/.{128}/g</span>);\n\n  <span class=\"hljs-keyword\">if</span> (!arrayM) <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Error</span>(<span class=\"hljs-string\">&quot;Failed to divide message&quot;</span>);\n\n  <span class=\"hljs-keyword\">return</span> arrayM;\n};\n</code></pre>\n<h2>使用する関数を定義しちゃう</h2>\n<p>下準備が終わったら、いよいよハッシュ値の算出に移ります。その際に繰り返し使用する関数をここで定義しておきます。</p>\n<p><eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mtext>ROTR</mtext><mi>n</mi></msup><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mo stretchy=\"false\">(</mo><mi>x</mi><mo>≫</mo><mi>n</mi><mo stretchy=\"false\">)</mo><mo>∨</mo><mo stretchy=\"false\">(</mo><mi>x</mi><mo>≪</mo><mo stretchy=\"false\">(</mo><mn>32</mn><mo>−</mo><mi>n</mi><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\text{ROTR}^{n}(x)=(x\\gg n)\\lor (x \\ll (32 - n))</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">ROTR</span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7376em;\"><span style=\"top:-3.1362em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≫</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">∨</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≪</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">32</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">))</span></span></span></span></eq><br>\n<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msup><mtext>SHR</mtext><mi>n</mi></msup><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>x</mi><mo>≫</mo><mi>n</mi></mrow><annotation encoding=\"application/x-tex\">\\text{SHR}^{n}(x)=x\\gg n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">SHR</span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7376em;\"><span style=\"top:-3.1362em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.5782em;vertical-align:-0.0391em;\"></span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≫</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">n</span></span></span></span></eq><br>\n<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>Ch</mtext><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><mi>y</mi><mo separator=\"true\">,</mo><mi>z</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mo stretchy=\"false\">(</mo><mi>x</mi><mo>∧</mo><mi>y</mi><mo stretchy=\"false\">)</mo><mo>⊕</mo><mo stretchy=\"false\">(</mo><mi mathvariant=\"normal\">¬</mi><mi>x</mi><mo>∧</mo><mi>z</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\text{Ch}(x,y,z) = (x \\land y)\\oplus(\\lnot x \\land z)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord text\"><span class=\"mord\">Ch</span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">∧</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⊕</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord\">¬</span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">∧</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"mclose\">)</span></span></span></span></eq><br>\n<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>Maj</mtext><mo stretchy=\"false\">(</mo><mi>x</mi><mo separator=\"true\">,</mo><mi>y</mi><mo separator=\"true\">,</mo><mi>z</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mo stretchy=\"false\">(</mo><mi>x</mi><mo>∧</mo><mi>y</mi><mo stretchy=\"false\">)</mo><mo>⊕</mo><mo stretchy=\"false\">(</mo><mi>x</mi><mo>∧</mo><mi>z</mi><mo stretchy=\"false\">)</mo><mo>⊕</mo><mo stretchy=\"false\">(</mo><mi>y</mi><mo>∧</mo><mi>z</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\text{Maj}(x,y,z) = (x \\land y)\\oplus(x \\land z)\\oplus(y \\land z)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord text\"><span class=\"mord\">Maj</span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">∧</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⊕</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">∧</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⊕</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">∧</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.04398em;\">z</span><span class=\"mclose\">)</span></span></span></span></eq><br>\n<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mi mathvariant=\"normal\">Σ</mi><mn>0</mn><mn>256</mn></msubsup><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><msup><mtext>ROTR</mtext><mn>2</mn></msup><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>⊕</mo><msup><mtext>ROTR</mtext><mn>13</mn></msup><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>⊕</mo><msup><mtext>ROTR</mtext><mn>22</mn></msup><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\Sigma^{256}_0(x) = \\text{ROTR}^{2}(x)\\oplus\\text{ROTR}^{13}(x)\\oplus\\text{ROTR}^{22}(x)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord\">Σ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-2.4519em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">256</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2481em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.1373em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">ROTR</span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8873em;\"><span style=\"top:-3.1362em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⊕</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.1373em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">ROTR</span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8873em;\"><span style=\"top:-3.1362em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">13</span></span></span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⊕</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.1373em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">ROTR</span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8873em;\"><span style=\"top:-3.1362em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">22</span></span></span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span></span></span></span></eq><br>\n<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mi mathvariant=\"normal\">Σ</mi><mn>1</mn><mn>256</mn></msubsup><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><msup><mtext>ROTR</mtext><mn>6</mn></msup><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>⊕</mo><msup><mtext>ROTR</mtext><mn>11</mn></msup><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>⊕</mo><msup><mtext>ROTR</mtext><mn>25</mn></msup><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\Sigma^{256}_1(x) = \\text{ROTR}^{6}(x)\\oplus\\text{ROTR}^{11}(x)\\oplus\\text{ROTR}^{25}(x)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord\">Σ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-2.4519em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">256</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2481em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.1373em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">ROTR</span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8873em;\"><span style=\"top:-3.1362em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">6</span></span></span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⊕</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.1373em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">ROTR</span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8873em;\"><span style=\"top:-3.1362em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">11</span></span></span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⊕</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.1373em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">ROTR</span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8873em;\"><span style=\"top:-3.1362em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">25</span></span></span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span></span></span></span></eq><br>\n<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mi>σ</mi><mn>0</mn><mn>256</mn></msubsup><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><msup><mtext>ROTR</mtext><mn>7</mn></msup><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>⊕</mo><msup><mtext>ROTR</mtext><mn>18</mn></msup><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>⊕</mo><msup><mtext>SHR</mtext><mn>3</mn></msup><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\sigma^{256}_0(x) = \\text{ROTR}^{7}(x)\\oplus\\text{ROTR}^{18}(x)\\oplus\\text{SHR}^{3}(x)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">σ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-2.4519em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">256</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2481em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.1373em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">ROTR</span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8873em;\"><span style=\"top:-3.1362em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">7</span></span></span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⊕</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.1373em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">ROTR</span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8873em;\"><span style=\"top:-3.1362em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">18</span></span></span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⊕</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.1373em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">SHR</span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8873em;\"><span style=\"top:-3.1362em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">3</span></span></span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span></span></span></span></eq><br>\n<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mi>σ</mi><mn>1</mn><mn>256</mn></msubsup><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>=</mo><msup><mtext>ROTR</mtext><mn>17</mn></msup><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>⊕</mo><msup><mtext>ROTR</mtext><mn>19</mn></msup><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo><mo>⊕</mo><msup><mtext>SHR</mtext><mn>10</mn></msup><mo stretchy=\"false\">(</mo><mi>x</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\sigma^{256}_1(x) = \\text{ROTR}^{17}(x)\\oplus\\text{ROTR}^{19}(x)\\oplus\\text{SHR}^{10}(x)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">σ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-2.4519em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">256</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2481em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.1373em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">ROTR</span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8873em;\"><span style=\"top:-3.1362em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">17</span></span></span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⊕</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.1373em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">ROTR</span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8873em;\"><span style=\"top:-3.1362em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">19</span></span></span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">⊕</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.1373em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">SHR</span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8873em;\"><span style=\"top:-3.1362em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">10</span></span></span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">x</span><span class=\"mclose\">)</span></span></span></span></eq></p>\n<pre><code class=\"language-typescript\"><span class=\"hljs-comment\">// ROTR関数の定義</span>\n<span class=\"hljs-keyword\">const</span> rotr = (<span class=\"hljs-attr\">x</span>: <span class=\"hljs-built_in\">number</span>, <span class=\"hljs-attr\">n</span>: <span class=\"hljs-built_in\">number</span>): <span class=\"hljs-function\"><span class=\"hljs-params\">number</span> =&gt;</span> ((x &gt;&gt;&gt; n) | (x &lt;&lt; (<span class=\"hljs-number\">32</span> - n))) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n<span class=\"hljs-comment\">// SHR関数の定義</span>\n<span class=\"hljs-keyword\">const</span> shr = (<span class=\"hljs-attr\">x</span>: <span class=\"hljs-built_in\">number</span>, <span class=\"hljs-attr\">n</span>: <span class=\"hljs-built_in\">number</span>): <span class=\"hljs-function\"><span class=\"hljs-params\">number</span> =&gt;</span> (x &gt;&gt;&gt; n) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n\n<span class=\"hljs-keyword\">const</span> ch = (<span class=\"hljs-attr\">x</span>: <span class=\"hljs-built_in\">number</span>, <span class=\"hljs-attr\">y</span>: <span class=\"hljs-built_in\">number</span>, <span class=\"hljs-attr\">z</span>: <span class=\"hljs-built_in\">number</span>): <span class=\"hljs-function\"><span class=\"hljs-params\">number</span> =&gt;</span> ((x &amp; y) ^ (~x &amp; z)) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n\n<span class=\"hljs-keyword\">const</span> maj = (<span class=\"hljs-attr\">x</span>: <span class=\"hljs-built_in\">number</span>, <span class=\"hljs-attr\">y</span>: <span class=\"hljs-built_in\">number</span>, <span class=\"hljs-attr\">z</span>: <span class=\"hljs-built_in\">number</span>): <span class=\"hljs-function\"><span class=\"hljs-params\">number</span> =&gt;</span> ((x &amp; y) ^ (x &amp; z) ^ (y &amp; z)) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n\n<span class=\"hljs-keyword\">const</span> upperSigma0 = (<span class=\"hljs-attr\">x</span>: <span class=\"hljs-built_in\">number</span>): <span class=\"hljs-function\"><span class=\"hljs-params\">number</span> =&gt;</span> (<span class=\"hljs-title function_\">rotr</span>(x, <span class=\"hljs-number\">2</span>) ^ <span class=\"hljs-title function_\">rotr</span>(x, <span class=\"hljs-number\">13</span>) ^ <span class=\"hljs-title function_\">rotr</span>(x, <span class=\"hljs-number\">22</span>)) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n\n<span class=\"hljs-keyword\">const</span> upperSigma1 = (<span class=\"hljs-attr\">x</span>: <span class=\"hljs-built_in\">number</span>): <span class=\"hljs-function\"><span class=\"hljs-params\">number</span> =&gt;</span> (<span class=\"hljs-title function_\">rotr</span>(x, <span class=\"hljs-number\">6</span>) ^ <span class=\"hljs-title function_\">rotr</span>(x, <span class=\"hljs-number\">11</span>) ^ <span class=\"hljs-title function_\">rotr</span>(x, <span class=\"hljs-number\">25</span>)) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n\n<span class=\"hljs-keyword\">const</span> lowerSigma0 = (<span class=\"hljs-attr\">x</span>: <span class=\"hljs-built_in\">number</span>): <span class=\"hljs-function\"><span class=\"hljs-params\">number</span> =&gt;</span> (<span class=\"hljs-title function_\">rotr</span>(x, <span class=\"hljs-number\">7</span>) ^ <span class=\"hljs-title function_\">rotr</span>(x, <span class=\"hljs-number\">18</span>) ^ <span class=\"hljs-title function_\">shr</span>(x, <span class=\"hljs-number\">3</span>)) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n\n<span class=\"hljs-keyword\">const</span> lowerSigma1 = (<span class=\"hljs-attr\">x</span>: <span class=\"hljs-built_in\">number</span>): <span class=\"hljs-function\"><span class=\"hljs-params\">number</span> =&gt;</span> (<span class=\"hljs-title function_\">rotr</span>(x, <span class=\"hljs-number\">17</span>) ^ <span class=\"hljs-title function_\">rotr</span>(x, <span class=\"hljs-number\">19</span>) ^ <span class=\"hljs-title function_\">shr</span>(x, <span class=\"hljs-number\">10</span>)) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n</code></pre>\n<h2>定数を定義しちゃう</h2>\n<p>ハッシュ値算出の際に使う定数も定義しておきましょう。といっても定数が64個入る配列を一つ作るだけです。<br>\n配列の中身は、<strong>小さい方から64個の素数の立方根の小数点以下4bytes</strong>です。例えば配列のいちばん最初は最初の素数である2の立方根<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mroot><mn>2</mn><mn>3</mn></mroot><mo>=</mo><mn>1.2599210498</mn><mo>=</mo><mtext>1.428a2f986ed84</mtext><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi></mrow><annotation encoding=\"application/x-tex\">\\sqrt[3]{2}=1.2599210498=\\text{1.428a2f986ed84}...</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.04em;vertical-align:-0.1328em;\"></span><span class=\"mord sqrt\"><span class=\"root\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7869em;\"><span style=\"top:-2.9647em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size6 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">3</span></span></span></span></span></span></span></span><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9072em;\"><span class=\"svg-align\" style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\" style=\"padding-left:0.833em;\"><span class=\"mord\">2</span></span></span><span style=\"top:-2.8672em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"hide-tail\" style=\"min-width:0.853em;height:1.08em;\"><svg xmlns=\"http://www.w3.org/2000/svg\" width='400em' height='1.08em' viewBox='0 0 400000 1080' preserveAspectRatio='xMinYMin slice'><path d='M95,702\nc-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14\nc0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54\nc44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10\ns173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429\nc69,-144,104.5,-217.7,106.5,-221\nl0 -0\nc5.3,-9.3,12,-14,20,-14\nH400000v40H845.2724\ns-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7\nc-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z\nM834 80h400000v40h-400000z'/></svg></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1328em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1.2599210498</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord text\"><span class=\"mord\">1.428a2f986ed84</span></span><span class=\"mord\">...</span></span></span></span></eq>の小数点以下4bytes<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>428a2f98</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{428a2f98}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord text\"><span class=\"mord\">428a2f98</span></span></span></span></span></eq>になります。なんでこんな値を取ってくるのでしょうか。僕にも分かりません。</p>\n<pre><code class=\"language-typescript\"><span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">K</span>: <span class=\"hljs-built_in\">number</span>[] = [\n  <span class=\"hljs-number\">0x428a2f98</span>, <span class=\"hljs-number\">0x71374491</span>, <span class=\"hljs-number\">0xb5c0fbcf</span>, <span class=\"hljs-number\">0xe9b5dba5</span>, <span class=\"hljs-number\">0x3956c25b</span>, <span class=\"hljs-number\">0x59f111f1</span>, <span class=\"hljs-number\">0x923f82a4</span>, <span class=\"hljs-number\">0xab1c5ed5</span>, <span class=\"hljs-number\">0xd807aa98</span>,\n  <span class=\"hljs-number\">0x12835b01</span>, <span class=\"hljs-number\">0x243185be</span>, <span class=\"hljs-number\">0x550c7dc3</span>, <span class=\"hljs-number\">0x72be5d74</span>, <span class=\"hljs-number\">0x80deb1fe</span>, <span class=\"hljs-number\">0x9bdc06a7</span>, <span class=\"hljs-number\">0xc19bf174</span>, <span class=\"hljs-number\">0xe49b69c1</span>, <span class=\"hljs-number\">0xefbe4786</span>,\n  <span class=\"hljs-number\">0x0fc19dc6</span>, <span class=\"hljs-number\">0x240ca1cc</span>, <span class=\"hljs-number\">0x2de92c6f</span>, <span class=\"hljs-number\">0x4a7484aa</span>, <span class=\"hljs-number\">0x5cb0a9dc</span>, <span class=\"hljs-number\">0x76f988da</span>, <span class=\"hljs-number\">0x983e5152</span>, <span class=\"hljs-number\">0xa831c66d</span>, <span class=\"hljs-number\">0xb00327c8</span>,\n  <span class=\"hljs-number\">0xbf597fc7</span>, <span class=\"hljs-number\">0xc6e00bf3</span>, <span class=\"hljs-number\">0xd5a79147</span>, <span class=\"hljs-number\">0x06ca6351</span>, <span class=\"hljs-number\">0x14292967</span>, <span class=\"hljs-number\">0x27b70a85</span>, <span class=\"hljs-number\">0x2e1b2138</span>, <span class=\"hljs-number\">0x4d2c6dfc</span>, <span class=\"hljs-number\">0x53380d13</span>,\n  <span class=\"hljs-number\">0x650a7354</span>, <span class=\"hljs-number\">0x766a0abb</span>, <span class=\"hljs-number\">0x81c2c92e</span>, <span class=\"hljs-number\">0x92722c85</span>, <span class=\"hljs-number\">0xa2bfe8a1</span>, <span class=\"hljs-number\">0xa81a664b</span>, <span class=\"hljs-number\">0xc24b8b70</span>, <span class=\"hljs-number\">0xc76c51a3</span>, <span class=\"hljs-number\">0xd192e819</span>,\n  <span class=\"hljs-number\">0xd6990624</span>, <span class=\"hljs-number\">0xf40e3585</span>, <span class=\"hljs-number\">0x106aa070</span>, <span class=\"hljs-number\">0x19a4c116</span>, <span class=\"hljs-number\">0x1e376c08</span>, <span class=\"hljs-number\">0x2748774c</span>, <span class=\"hljs-number\">0x34b0bcb5</span>, <span class=\"hljs-number\">0x391c0cb3</span>, <span class=\"hljs-number\">0x4ed8aa4a</span>,\n  <span class=\"hljs-number\">0x5b9cca4f</span>, <span class=\"hljs-number\">0x682e6ff3</span>, <span class=\"hljs-number\">0x748f82ee</span>, <span class=\"hljs-number\">0x78a5636f</span>, <span class=\"hljs-number\">0x84c87814</span>, <span class=\"hljs-number\">0x8cc70208</span>, <span class=\"hljs-number\">0x90befffa</span>, <span class=\"hljs-number\">0xa4506ceb</span>, <span class=\"hljs-number\">0xbef9a3f7</span>,\n  <span class=\"hljs-number\">0xc67178f2</span>\n];\n</code></pre>\n<p>定数ですので実行するたびに「小さい方から64個の素数の立方根の小数点以下4byteを取ってきて配列に入れて…」とかやる必要はありません。</p>\n<h2>ハッシュ値を算出していく</h2>\n<p>いよいよ本題です。ハッシュ値の算出手順は、まず先ほど64bytesごとに切り分けたメッセージブロックをさらに4bytesのブロック、つまり半角文字1文字ずつに切り分けます。そしてそのWord一つ一つに対してローテーションという処理を行っていきます。</p>\n<p>以降、足し算の際には、32bits符号なし整数型であることを保証するため必ず<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>0x100000000</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{0x100000000}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord text\"><span class=\"mord\">0x100000000</span></span></span></span></span></eq>との剰余をとります。実装の際には<code>&amp; 0xffffffff</code>と論理積を使って剰余を擬似的に再現します。</p>\n<h3>ハッシュ値を入れる配列を定義する</h3>\n<p>まずはローテーション処理の肝となる配列を定義します</p>\n<pre><code class=\"language-typescript\"><span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">H</span>: <span class=\"hljs-built_in\">number</span>[] = [<span class=\"hljs-number\">0x6a09e667</span>, <span class=\"hljs-number\">0xbb67ae85</span>, <span class=\"hljs-number\">0x3c6ef372</span>, <span class=\"hljs-number\">0xa54ff53a</span>, <span class=\"hljs-number\">0x510e527f</span>, <span class=\"hljs-number\">0x9b05688c</span>, <span class=\"hljs-number\">0x1f83d9ab</span>, <span class=\"hljs-number\">0x5be0cd19</span>];\n</code></pre>\n<p>これは後々ハッシュ値が格納され、ローテーション処理に使われる配列です。上の初期値は<strong>小さい方から8個の素数の平方根の小数点以下32bits</strong>です。先ほどの定数<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>K</mi><mn>0</mn></msub><mo separator=\"true\">,</mo><msub><mi>K</mi><mn>1</mn></msub><mo separator=\"true\">,</mo><msub><mi>K</mi><mn>2</mn></msub><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><msub><mi>K</mi><mn>63</mn></msub></mrow><annotation encoding=\"application/x-tex\">K_{0},K_{1},K_{2}...K_{63}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8778em;vertical-align:-0.1944em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">0</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord\">...</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">63</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></eq>は立方根でしたが今回は平方根です。ほんとなんなんでしょうねこれ。</p>\n<h3>ブロックをさらに切り分ける</h3>\n<pre><code class=\"language-typescript\"><span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">paddedString</span>: <span class=\"hljs-built_in\">string</span> = <span class=\"hljs-title function_\">padding</span>(M);\n<span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">dividedM</span>: <span class=\"hljs-built_in\">string</span>[] = <span class=\"hljs-title function_\">divideM</span>(paddedString);\n\n  <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">let</span> i = <span class=\"hljs-number\">0</span>; i &lt; dividedM.<span class=\"hljs-property\">length</span>; i++) {\n    <span class=\"hljs-keyword\">const</span> <span class=\"hljs-title class_\">Mi</span>: <span class=\"hljs-title class_\">RegExpMatchArray</span> | <span class=\"hljs-literal\">null</span> = dividedM[i].<span class=\"hljs-title function_\">match</span>(<span class=\"hljs-regexp\">/.{8}/g</span>); <span class=\"hljs-comment\">// 64bytesのブロックをさらに4byteずつ刻んでいく</span>\n\n    <span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-title class_\">Mi</span>) <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Error</span>(<span class=\"hljs-string\">&quot;Failed to divide dividedM&quot;</span>);\n    <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">W</span>: <span class=\"hljs-built_in\">number</span>[] = <span class=\"hljs-title function_\">mapW</span>(<span class=\"hljs-title class_\">Array</span>(<span class=\"hljs-number\">64</span>), <span class=\"hljs-title class_\">Mi</span>);\n    ...\n</code></pre>\n<p>先述の<code>divideM</code>関数で切り分けた64bytesのブロック一つ一つについて、<code>Mi</code>に4bytesづつ切り分けた変数を格納しています。ここで正規表現で8文字ずつ切り出しているのはPadding関数の時と同じく、後々数値に変換する際に2文字ごとに１６進数として読んでもらう必要があるからです。<br>\n最後の<code>mapW</code>関数では<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>W</mi></mrow><annotation encoding=\"application/x-tex\">W</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span></span></span></span></eq>という64個の要素を持つ配列を生成します。それでは<code>mapW</code>関数の中身をみてみましょう</p>\n<h3>Wを作る</h3>\n<p>ハッシュ値の算出に必要な<strong>メッセージスケジュール</strong>なるものを<code>mapW</code>関数で生成します。</p>\n<pre><code class=\"language-typescript\"><span class=\"hljs-keyword\">const</span> mapW = (<span class=\"hljs-attr\">array64</span>: <span class=\"hljs-built_in\">number</span>[], <span class=\"hljs-title class_\">Mi</span>: <span class=\"hljs-built_in\">string</span>[]): <span class=\"hljs-built_in\">number</span>[] =&gt; {\n  <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">let</span> i = <span class=\"hljs-number\">0</span>; i &lt; <span class=\"hljs-number\">64</span>; i++) {\n    <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">hexNum</span>: <span class=\"hljs-built_in\">number</span> = <span class=\"hljs-built_in\">parseInt</span>(<span class=\"hljs-title class_\">Mi</span>[i], <span class=\"hljs-number\">16</span>);\n\n    <span class=\"hljs-keyword\">if</span> (i &lt; <span class=\"hljs-number\">16</span>) {\n      array64[i] = hexNum;\n      <span class=\"hljs-keyword\">continue</span>;\n    }\n    <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">tmp</span>: <span class=\"hljs-built_in\">number</span> = <span class=\"hljs-title function_\">lowerSigma1</span>(array64[i - <span class=\"hljs-number\">2</span>]) + array64[i - <span class=\"hljs-number\">7</span>] + <span class=\"hljs-title function_\">lowerSigma0</span>(array64[i - <span class=\"hljs-number\">15</span>]) + array64[i - <span class=\"hljs-number\">16</span>];\n\n    array64[i] = (tmp &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n  }\n  <span class=\"hljs-keyword\">return</span> array64;\n};\n</code></pre>\n<p>第一引数には64個の空要素を持つ配列、第二引数にはブロックを4bytesに切り刻んだ配列をとります。</p>\n<pre><code class=\"language-typescript\"><span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">hexNum</span>: <span class=\"hljs-built_in\">number</span> = <span class=\"hljs-built_in\">parseInt</span>(<span class=\"hljs-title class_\">Mi</span>[i], <span class=\"hljs-number\">16</span>);\n</code></pre>\n<p>この数値化部分で、これまで0をbyte×2個生成したりbyte×2文字でブロックを切り分けたりしていたことが生きてきます。そうやって半ば強引に生成した擬似的な16進数文字列のおかげで論理演算やシフト演算が円滑に行えるのです。</p>\n<pre><code>if (i &lt; 16) {\n  array64[i] = hexNum;\n  continue;\n}\n</code></pre>\n<p><eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>W</mi></mrow><annotation encoding=\"application/x-tex\">W</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span></span></span></span></eq>の1~16番目には数値化したメッセージブロック4bytesを格納します。<br>\nそれ以降のインデックスには以下の式で算出した値を格納します。<br>\n<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>W</mi><mi>t</mi></msub><mo>=</mo><msubsup><mi>σ</mi><mn>1</mn><mn>256</mn></msubsup><mo stretchy=\"false\">(</mo><msub><mi>W</mi><mrow><mi>t</mi><mo>−</mo><mn>2</mn></mrow></msub><mo stretchy=\"false\">)</mo><mo>+</mo><msub><mi>W</mi><mrow><mi>t</mi><mo>−</mo><mn>7</mn></mrow></msub><mo>+</mo><msubsup><mi>σ</mi><mn>0</mn><mn>256</mn></msubsup><mo stretchy=\"false\">(</mo><msub><mi>W</mi><mrow><mi>t</mi><mo>−</mo><mn>15</mn></mrow></msub><mo stretchy=\"false\">)</mo><mo>+</mo><msub><mi>W</mi><mrow><mi>t</mi><mo>−</mo><mn>16</mn></mrow></msub></mrow><annotation encoding=\"application/x-tex\">W_{t}=\\sigma^{256}_1(W_{t-2})+W_{t-7}+\\sigma^{256}_0(W_{t-15})+W_{t-16}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2806em;\"><span style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">σ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-2.4519em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">256</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2481em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">2</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2083em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8917em;vertical-align:-0.2083em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">7</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2083em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">σ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-2.4519em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">0</span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">256</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2481em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">15</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2083em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8917em;vertical-align:-0.2083em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">16</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2083em;\"><span></span></span></span></span></span></span></span></span></span></eq><br>\nかなりややこしいですが先ほど定義しておいた関数に当てはめるだけなので実装自体は単純です。</p>\n<pre><code class=\"language-typescript\">  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">tmp</span>: <span class=\"hljs-built_in\">number</span> = <span class=\"hljs-title function_\">lowerSigma1</span>(array64[i - <span class=\"hljs-number\">2</span>]) + array64[i - <span class=\"hljs-number\">7</span>] + <span class=\"hljs-title function_\">lowerSigma0</span>(array64[i - <span class=\"hljs-number\">15</span>]) + array64[i - <span class=\"hljs-number\">16</span>];\n\n  array64[i] = (tmp &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n}\n  <span class=\"hljs-keyword\">return</span> array64; <span class=\"hljs-comment\">// Wを返してmapW関数は終了</span>\n</code></pre>\n<p>途中の<code>(tmp &amp; 0xffffffff) &gt;&gt;&gt; 0</code>の最後の符号なし右シフトは何をしているのかというと、tmpの値と<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mtext>0xffffffff</mtext></mrow><annotation encoding=\"application/x-tex\">\\text{0xffffffff}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord text\"><span class=\"mord\">0xffffffff</span></span></span></span></span></eq>の剰余を強制的に符号なし、つまりプラスの値に変換しているのです。他の言語であればこんなことしなくても符号なしの演算はできるのですが、<strong>JavaScriptはこの符号なし右シフト以外で確実に非負の数であると保証する方法はありません。</strong><code>(tmp &amp; 0xffffffff)</code>がすでに非負だった場合この演算は無意味ですが、負の数だった場合はこのめんどい作業が必要になります。</p>\n<h3>前のブロックで生成されたハッシュ値を変数に代入する</h3>\n<p>メインのハッシュ値算出関数に戻ります。</p>\n<pre><code class=\"language-typescript\"><span class=\"hljs-keyword\">let</span> a, b, c, d, e, f, g, h;\n\n[a, b, c, d, e, f, g, h] = [...H];\n</code></pre>\n<p>ここで変数a~hにブロックごとのループの最後で生成されるハッシュ値、つまり一つ前のブロックのハッシュ値を代入していきます。</p>\n<h3>Wを使ったローテーション</h3>\n<p>先ほど<code>mapW</code>関数で生成したW配列をイテレートして上の変数a~hの値をローテーションしていきます。<br>\nイテレートが始まったら、最初に一時的に値を保管す変数<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding=\"application/x-tex\">T_{1}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></eq>と<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>T</mi><mn>2</mn></msub></mrow><annotation encoding=\"application/x-tex\">T_{2}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></eq>を定義します。<br>\n<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub><mo>=</mo><mtext>h</mtext><mo>+</mo><msubsup><mi mathvariant=\"normal\">Σ</mi><mn>1</mn><mn>256</mn></msubsup><mo stretchy=\"false\">(</mo><mi>e</mi><mo stretchy=\"false\">)</mo><mo>+</mo><mtext>Ch</mtext><mo stretchy=\"false\">(</mo><mi>e</mi><mo separator=\"true\">,</mo><mi>f</mi><mo separator=\"true\">,</mo><mi>g</mi><mo stretchy=\"false\">)</mo><mo>+</mo><msub><mi>K</mi><mi>t</mi></msub><mo>+</mo><msub><mi>W</mi><mi>t</mi></msub></mrow><annotation encoding=\"application/x-tex\">T_{1}=\\text{h}+\\Sigma^{256}_{1}(e)+\\text{Ch}(e,f,g)+K_{t}+W_{t}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7778em;vertical-align:-0.0833em;\"></span><span class=\"mord text\"><span class=\"mord\">h</span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord\">Σ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-2.4519em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span></span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">256</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2481em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">e</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord text\"><span class=\"mord\">Ch</span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">e</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2806em;\"><span style=\"top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2806em;\"><span style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></eq><br>\n<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>T</mi><mn>2</mn></msub><mo>=</mo><msubsup><mi mathvariant=\"normal\">Σ</mi><mn>0</mn><mn>256</mn></msubsup><mo stretchy=\"false\">(</mo><mi>a</mi><mo stretchy=\"false\">)</mo><mo>+</mo><mtext>Maj</mtext><mo stretchy=\"false\">(</mo><mi>a</mi><mo separator=\"true\">,</mo><mi>b</mi><mo separator=\"true\">,</mo><mi>c</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">T_{2}=\\Sigma^{256}_{0}(a)+\\text{Maj}(a,b,c)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord\">Σ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-2.4519em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">0</span></span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">256</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2481em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">a</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord text\"><span class=\"mord\">Maj</span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">a</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">b</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mclose\">)</span></span></span></span></eq></p>\n<pre><code class=\"language-typescript\"><span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">let</span> t = <span class=\"hljs-number\">0</span>; t &lt; <span class=\"hljs-number\">64</span>; t++) {\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">T1</span>: <span class=\"hljs-built_in\">number</span> = ((h + <span class=\"hljs-title function_\">upperSigma1</span>(e) + <span class=\"hljs-title function_\">ch</span>(e, f, g) + K[t] + W[t]) &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">T2</span>: <span class=\"hljs-built_in\">number</span> = ((<span class=\"hljs-title function_\">upperSigma0</span>(a) + <span class=\"hljs-title function_\">maj</span>(a, b, c)) &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n\n  h = g;\n  g = f;\n  f = e;\n  e = ((d + <span class=\"hljs-variable constant_\">T1</span>) &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n  d = c;\n  c = b;\n  b = a;\n  a = ((<span class=\"hljs-variable constant_\">T1</span> + <span class=\"hljs-variable constant_\">T2</span>) &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n}\n</code></pre>\n<p>eとa以外はひとつ前のアルファベットの値が代入されるだけで、eは<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>d</mi><mo>+</mo><msub><mi>T</mi><mn>1</mn></msub></mrow><annotation encoding=\"application/x-tex\">d+T_{1}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7778em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></eq>、aは<eq><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>T</mi><mn>1</mn></msub><mo>+</mo><msub><mi>T</mi><mn>2</mn></msub></mrow><annotation encoding=\"application/x-tex\">T_{1}+T_{2}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span></eq>になります。これをW内の要素全て、つまり64回分行います。<br>\nメッセージをabcとしてこのローテーション処理を行った際のa~hの変化が以下です</p>\n<pre><code>5d6aebcd 6a09e667 bb67ae85 3c6ef372 fa2a4622 510e527f 9b05688c 1f83d9ab\n5a6ad9ad 5d6aebcd 6a09e667 bb67ae85 78ce7989 fa2a4622 510e527f 9b05688c\nc8c347a7 5a6ad9ad 5d6aebcd 6a09e667 f92939eb 78ce7989 fa2a4622 510e527f\nd550f666 c8c347a7 5a6ad9ad 5d6aebcd 24e00850 f92939eb 78ce7989 fa2a4622\n4409a6a d550f666 c8c347a7 5a6ad9ad 43ada245 24e00850 f92939eb 78ce7989\n2b4209f5 4409a6a d550f666 c8c347a7 714260ad 43ada245 24e00850 f92939eb\ne5030380 2b4209f5 4409a6a d550f666 9b27a401 714260ad 43ada245 24e00850\n85a07b5f e5030380 2b4209f5 4409a6a c657a79 9b27a401 714260ad 43ada245\n8e04ecb9 85a07b5f e5030380 2b4209f5 32ca2d8c c657a79 9b27a401 714260ad\n8c87346b 8e04ecb9 85a07b5f e5030380 1cc92596 32ca2d8c c657a79 9b27a401\n4798a3f4 8c87346b 8e04ecb9 85a07b5f 436b23e8 1cc92596 32ca2d8c c657a79\nf71fc5a9 4798a3f4 8c87346b 8e04ecb9 816fd6e9 436b23e8 1cc92596 32ca2d8c\n87912990 f71fc5a9 4798a3f4 8c87346b 1e578218 816fd6e9 436b23e8 1cc92596\nd932eb16 87912990 f71fc5a9 4798a3f4 745a48de 1e578218 816fd6e9 436b23e8\n続く...\n</code></pre>\n<p>斜めに値がローテーションし、一番左と左から5行目、つまりaとeで毎度値が変わっているのが分かるはずです。</p>\n<h3>前のハッシュ値とa~hを足す</h3>\n<pre><code class=\"language-typescript\">  H[<span class=\"hljs-number\">0</span>] = ((a + H[<span class=\"hljs-number\">0</span>]) &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n  H[<span class=\"hljs-number\">1</span>] = ((b + H[<span class=\"hljs-number\">1</span>]) &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n  H[<span class=\"hljs-number\">2</span>] = ((c + H[<span class=\"hljs-number\">2</span>]) &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n  H[<span class=\"hljs-number\">3</span>] = ((d + H[<span class=\"hljs-number\">3</span>]) &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n  H[<span class=\"hljs-number\">4</span>] = ((e + H[<span class=\"hljs-number\">4</span>]) &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n  H[<span class=\"hljs-number\">5</span>] = ((f + H[<span class=\"hljs-number\">5</span>]) &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n  H[<span class=\"hljs-number\">6</span>] = ((g + H[<span class=\"hljs-number\">6</span>]) &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n  H[<span class=\"hljs-number\">7</span>] = ((h + H[<span class=\"hljs-number\">7</span>]) &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n}<span class=\"hljs-comment\">// ↖︎次のブロックへ</span>\n</code></pre>\n<p>前のブロックのハッシュ値とa~hの値を加算し、このブロックのハッシュ値が完成します。</p>\n<h2>ハッシュ値をハッシュ値にする</h2>\n<p>以上の流れをブロック数回行うと、最後のHには一方向性と耐衝突性を持つハッシュ値が格納された状態になります。しかしこのままでは配列なので、それを結合して文字列の形に直します。<br>\n配列を結合するだけなら簡単なのですが、ここでも少し罠があったので紹介します。</p>\n<pre><code class=\"language-typescript\"><span class=\"hljs-keyword\">let</span> <span class=\"hljs-attr\">result</span>: <span class=\"hljs-built_in\">string</span> = <span class=\"hljs-string\">&quot;&quot;</span>;\n\nH.<span class=\"hljs-title function_\">map</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">b</span> =&gt;</span> {\n  <span class=\"hljs-keyword\">let</span> <span class=\"hljs-attr\">hashString</span>: <span class=\"hljs-built_in\">string</span> = b.<span class=\"hljs-title function_\">toString</span>(<span class=\"hljs-number\">16</span>);\n  <span class=\"hljs-keyword\">if</span>(hashString.<span class=\"hljs-property\">length</span> &lt; <span class=\"hljs-number\">8</span>) {\n    <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">extraZeros</span>: <span class=\"hljs-built_in\">string</span> = <span class=\"hljs-title class_\">Array</span>(<span class=\"hljs-number\">8</span> - hashString.<span class=\"hljs-property\">length</span>).<span class=\"hljs-title function_\">fill</span>(<span class=\"hljs-number\">0</span>).<span class=\"hljs-title function_\">join</span>(<span class=\"hljs-string\">&#x27;&#x27;</span>);\n    hashString = extraZeros + hashString;\n  }\n  result += hashString;\n});\n<span class=\"hljs-keyword\">if</span>(result.<span class=\"hljs-property\">length</span> !== <span class=\"hljs-number\">64</span>) <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Error</span>(<span class=\"hljs-string\">&quot;Hash result is not 32bytes&quot;</span>);\n\n<span class=\"hljs-keyword\">return</span> result; <span class=\"hljs-comment\">// SHA-256完成！</span>\n</code></pre>\n<p>真ん中のHをイテレートしている部分は何をやっているのかというと、配列の要素ひとつひとつの文字数を測り、8文字に満たない場合はその分0を先頭に追加しています。これは、<code>hashString</code>で数値を文字列に変換した際に、先頭に0があるとそれは省略されて文字列化されてしまうのです。そうすると結果が256bitsでなくなってしまうので、無理矢理ではありますが省略分の0を加える必要があるのです。</p>\n<h2>ソースコード</h2>\n<p>だいぶ細々と説明をしてきたので、最後に全体のソースコードを貼っておきます。これは一番上で貼ったリポジトリでも見ることができます。</p>\n<pre><code class=\"language-typescript\"><span class=\"hljs-comment\">// 文字列を引数にとり、64の倍数bytesのHex文字列を返す</span>\n<span class=\"hljs-keyword\">const</span> padding = (<span class=\"hljs-attr\">M</span>: <span class=\"hljs-built_in\">string</span>): <span class=\"hljs-function\"><span class=\"hljs-params\">string</span> =&gt;</span> {\n  <span class=\"hljs-keyword\">let</span> <span class=\"hljs-attr\">sizeLastBlock</span>: <span class=\"hljs-built_in\">number</span> = <span class=\"hljs-number\">64</span>; <span class=\"hljs-comment\">// Mの末尾のブロックサイズ</span>\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">sizeMLengthBuffer</span>: <span class=\"hljs-built_in\">number</span> = <span class=\"hljs-number\">8</span>; <span class=\"hljs-comment\">// 最終的なメッセージの末尾8bytesはMのサイズを記述する</span>\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">sizeDivision</span>: <span class=\"hljs-built_in\">number</span> = <span class=\"hljs-number\">1</span>; <span class=\"hljs-comment\">// メッセージバイトと余りの0バイトの区切り（0x80）</span>\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">sizeMaxBlock</span>: <span class=\"hljs-built_in\">number</span> = sizeLastBlock - sizeMLengthBuffer - sizeDivision; <span class=\"hljs-comment\">// メッセージバイトは55bytes以下であれば良い</span>\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">sizeM</span>: <span class=\"hljs-built_in\">number</span> = <span class=\"hljs-built_in\">encodeURI</span>(M).<span class=\"hljs-title function_\">replace</span>(<span class=\"hljs-regexp\">/%../g</span>, <span class=\"hljs-string\">&quot;*&quot;</span>).<span class=\"hljs-property\">length</span>;\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">sizeLastM</span>: <span class=\"hljs-built_in\">number</span> = sizeM % <span class=\"hljs-number\">64</span>;\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">isOverflow</span>: <span class=\"hljs-built_in\">boolean</span> = sizeMaxBlock &lt; sizeLastM;\n\n  <span class=\"hljs-keyword\">if</span> (isOverflow) sizeLastBlock = <span class=\"hljs-number\">128</span>; <span class=\"hljs-comment\">// Mの最後のブロックのバイトサイズが55bytesを超えていると1ブロックに格納できないため１ブロック追加する</span>\n  <span class=\"hljs-comment\">// Mを16進数文字列に変換</span>\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">hexStringM</span>: <span class=\"hljs-built_in\">string</span> = <span class=\"hljs-title class_\">Array</span>.<span class=\"hljs-title function_\">from</span>((<span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">TextEncoder</span>()).<span class=\"hljs-title function_\">encode</span>(M)).<span class=\"hljs-title function_\">map</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">v</span> =&gt;</span> v.<span class=\"hljs-title function_\">toString</span>(<span class=\"hljs-number\">16</span>)).<span class=\"hljs-title function_\">join</span>(<span class=\"hljs-string\">&quot;&quot;</span>);\n  <span class=\"hljs-comment\">// 余りの0の配列を生成</span>\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">sizeExtra</span>: <span class=\"hljs-built_in\">number</span> = (sizeLastBlock - sizeMLengthBuffer - sizeDivision - sizeLastM) * <span class=\"hljs-number\">2</span>;\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">hexExtraString</span>: <span class=\"hljs-built_in\">string</span> = <span class=\"hljs-title class_\">Array</span>(sizeExtra).<span class=\"hljs-title function_\">fill</span>(<span class=\"hljs-number\">0</span>).<span class=\"hljs-title function_\">join</span>(<span class=\"hljs-string\">&quot;&quot;</span>);\n  <span class=\"hljs-comment\">// Mのサイズを8bytesで表現する</span>\n  <span class=\"hljs-keyword\">const</span> hexSizeM : <span class=\"hljs-built_in\">string</span>= (sizeM * <span class=\"hljs-number\">8</span>).<span class=\"hljs-title function_\">toString</span>(<span class=\"hljs-number\">16</span>);\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">hex8bytesLengthM</span>: <span class=\"hljs-built_in\">string</span> = <span class=\"hljs-title class_\">Array</span>(<span class=\"hljs-number\">16</span> - hexSizeM.<span class=\"hljs-property\">length</span>).<span class=\"hljs-title function_\">fill</span>(<span class=\"hljs-number\">0</span>).<span class=\"hljs-title function_\">concat</span>(hexSizeM).<span class=\"hljs-title function_\">join</span>(<span class=\"hljs-string\">&quot;&quot;</span>);\n  <span class=\"hljs-comment\">// 64bytesの倍数になったPaddedStringを生成</span>\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">resultString</span>: <span class=\"hljs-built_in\">string</span> = hexStringM + <span class=\"hljs-string\">&quot;80&quot;</span> + hexExtraString + hex8bytesLengthM;\n\n  <span class=\"hljs-keyword\">return</span> resultString;\n};\n\n<span class=\"hljs-comment\">// 64の倍数bytesのHex文字列を引数にとり、64bytesごとに切り分けた配列を返す</span>\n<span class=\"hljs-keyword\">const</span> divideM = (<span class=\"hljs-attr\">M</span>: <span class=\"hljs-built_in\">string</span>): <span class=\"hljs-built_in\">string</span>[] =&gt; {\n  <span class=\"hljs-comment\">// 文字列として扱っているので64bytesは128文字</span>\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">arrayM</span>: <span class=\"hljs-title class_\">RegExpMatchArray</span> | <span class=\"hljs-literal\">null</span> = M.<span class=\"hljs-title function_\">match</span>(<span class=\"hljs-regexp\">/.{128}/g</span>);\n\n  <span class=\"hljs-keyword\">if</span> (!arrayM) <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Error</span>(<span class=\"hljs-string\">&quot;Failed to divide message&quot;</span>);\n\n  <span class=\"hljs-keyword\">return</span> arrayM;\n};\n\n<span class=\"hljs-keyword\">const</span> ch = (<span class=\"hljs-attr\">x</span>: <span class=\"hljs-built_in\">number</span>, <span class=\"hljs-attr\">y</span>: <span class=\"hljs-built_in\">number</span>, <span class=\"hljs-attr\">z</span>: <span class=\"hljs-built_in\">number</span>): <span class=\"hljs-function\"><span class=\"hljs-params\">number</span> =&gt;</span> ((x &amp; y) ^ (~x &amp; z)) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n\n<span class=\"hljs-keyword\">const</span> maj = (<span class=\"hljs-attr\">x</span>: <span class=\"hljs-built_in\">number</span>, <span class=\"hljs-attr\">y</span>: <span class=\"hljs-built_in\">number</span>, <span class=\"hljs-attr\">z</span>: <span class=\"hljs-built_in\">number</span>): <span class=\"hljs-function\"><span class=\"hljs-params\">number</span> =&gt;</span> ((x &amp; y) ^ (x &amp; z) ^ (y &amp; z)) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n\n<span class=\"hljs-keyword\">const</span> rotr = (<span class=\"hljs-attr\">x</span>: <span class=\"hljs-built_in\">number</span>, <span class=\"hljs-attr\">n</span>: <span class=\"hljs-built_in\">number</span>): <span class=\"hljs-function\"><span class=\"hljs-params\">number</span> =&gt;</span> ((x &gt;&gt;&gt; n) | (x &lt;&lt; (<span class=\"hljs-number\">32</span> - n))) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n\n<span class=\"hljs-keyword\">const</span> shr = (<span class=\"hljs-attr\">x</span>: <span class=\"hljs-built_in\">number</span>, <span class=\"hljs-attr\">n</span>: <span class=\"hljs-built_in\">number</span>): <span class=\"hljs-function\"><span class=\"hljs-params\">number</span> =&gt;</span> (x &gt;&gt;&gt; n) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n\n<span class=\"hljs-keyword\">const</span> upperSigma0 = (<span class=\"hljs-attr\">x</span>: <span class=\"hljs-built_in\">number</span>): <span class=\"hljs-function\"><span class=\"hljs-params\">number</span> =&gt;</span> (<span class=\"hljs-title function_\">rotr</span>(x, <span class=\"hljs-number\">2</span>) ^ <span class=\"hljs-title function_\">rotr</span>(x, <span class=\"hljs-number\">13</span>) ^ <span class=\"hljs-title function_\">rotr</span>(x, <span class=\"hljs-number\">22</span>)) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n\n<span class=\"hljs-keyword\">const</span> upperSigma1 = (<span class=\"hljs-attr\">x</span>: <span class=\"hljs-built_in\">number</span>): <span class=\"hljs-function\"><span class=\"hljs-params\">number</span> =&gt;</span> (<span class=\"hljs-title function_\">rotr</span>(x, <span class=\"hljs-number\">6</span>) ^ <span class=\"hljs-title function_\">rotr</span>(x, <span class=\"hljs-number\">11</span>) ^ <span class=\"hljs-title function_\">rotr</span>(x, <span class=\"hljs-number\">25</span>)) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n\n<span class=\"hljs-keyword\">const</span> lowerSigma0 = (<span class=\"hljs-attr\">x</span>: <span class=\"hljs-built_in\">number</span>): <span class=\"hljs-function\"><span class=\"hljs-params\">number</span> =&gt;</span> (<span class=\"hljs-title function_\">rotr</span>(x, <span class=\"hljs-number\">7</span>) ^ <span class=\"hljs-title function_\">rotr</span>(x, <span class=\"hljs-number\">18</span>) ^ <span class=\"hljs-title function_\">shr</span>(x, <span class=\"hljs-number\">3</span>)) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n\n<span class=\"hljs-keyword\">const</span> lowerSigma1 = (<span class=\"hljs-attr\">x</span>: <span class=\"hljs-built_in\">number</span>): <span class=\"hljs-function\"><span class=\"hljs-params\">number</span> =&gt;</span> (<span class=\"hljs-title function_\">rotr</span>(x, <span class=\"hljs-number\">17</span>) ^ <span class=\"hljs-title function_\">rotr</span>(x, <span class=\"hljs-number\">19</span>) ^ <span class=\"hljs-title function_\">shr</span>(x, <span class=\"hljs-number\">10</span>)) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n\n<span class=\"hljs-comment\">// 小さい方から64個の素数の立方根の小数点以下4bytesの定数</span>\n<span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">K</span>: <span class=\"hljs-built_in\">number</span>[] = [\n  <span class=\"hljs-number\">0x428a2f98</span>, <span class=\"hljs-number\">0x71374491</span>, <span class=\"hljs-number\">0xb5c0fbcf</span>, <span class=\"hljs-number\">0xe9b5dba5</span>, <span class=\"hljs-number\">0x3956c25b</span>, <span class=\"hljs-number\">0x59f111f1</span>, <span class=\"hljs-number\">0x923f82a4</span>, <span class=\"hljs-number\">0xab1c5ed5</span>, <span class=\"hljs-number\">0xd807aa98</span>,\n  <span class=\"hljs-number\">0x12835b01</span>, <span class=\"hljs-number\">0x243185be</span>, <span class=\"hljs-number\">0x550c7dc3</span>, <span class=\"hljs-number\">0x72be5d74</span>, <span class=\"hljs-number\">0x80deb1fe</span>, <span class=\"hljs-number\">0x9bdc06a7</span>, <span class=\"hljs-number\">0xc19bf174</span>, <span class=\"hljs-number\">0xe49b69c1</span>, <span class=\"hljs-number\">0xefbe4786</span>,\n  <span class=\"hljs-number\">0x0fc19dc6</span>, <span class=\"hljs-number\">0x240ca1cc</span>, <span class=\"hljs-number\">0x2de92c6f</span>, <span class=\"hljs-number\">0x4a7484aa</span>, <span class=\"hljs-number\">0x5cb0a9dc</span>, <span class=\"hljs-number\">0x76f988da</span>, <span class=\"hljs-number\">0x983e5152</span>, <span class=\"hljs-number\">0xa831c66d</span>, <span class=\"hljs-number\">0xb00327c8</span>,\n  <span class=\"hljs-number\">0xbf597fc7</span>, <span class=\"hljs-number\">0xc6e00bf3</span>, <span class=\"hljs-number\">0xd5a79147</span>, <span class=\"hljs-number\">0x06ca6351</span>, <span class=\"hljs-number\">0x14292967</span>, <span class=\"hljs-number\">0x27b70a85</span>, <span class=\"hljs-number\">0x2e1b2138</span>, <span class=\"hljs-number\">0x4d2c6dfc</span>, <span class=\"hljs-number\">0x53380d13</span>,\n  <span class=\"hljs-number\">0x650a7354</span>, <span class=\"hljs-number\">0x766a0abb</span>, <span class=\"hljs-number\">0x81c2c92e</span>, <span class=\"hljs-number\">0x92722c85</span>, <span class=\"hljs-number\">0xa2bfe8a1</span>, <span class=\"hljs-number\">0xa81a664b</span>, <span class=\"hljs-number\">0xc24b8b70</span>, <span class=\"hljs-number\">0xc76c51a3</span>, <span class=\"hljs-number\">0xd192e819</span>,\n  <span class=\"hljs-number\">0xd6990624</span>, <span class=\"hljs-number\">0xf40e3585</span>, <span class=\"hljs-number\">0x106aa070</span>, <span class=\"hljs-number\">0x19a4c116</span>, <span class=\"hljs-number\">0x1e376c08</span>, <span class=\"hljs-number\">0x2748774c</span>, <span class=\"hljs-number\">0x34b0bcb5</span>, <span class=\"hljs-number\">0x391c0cb3</span>, <span class=\"hljs-number\">0x4ed8aa4a</span>,\n  <span class=\"hljs-number\">0x5b9cca4f</span>, <span class=\"hljs-number\">0x682e6ff3</span>, <span class=\"hljs-number\">0x748f82ee</span>, <span class=\"hljs-number\">0x78a5636f</span>, <span class=\"hljs-number\">0x84c87814</span>, <span class=\"hljs-number\">0x8cc70208</span>, <span class=\"hljs-number\">0x90befffa</span>, <span class=\"hljs-number\">0xa4506ceb</span>, <span class=\"hljs-number\">0xbef9a3f7</span>,\n  <span class=\"hljs-number\">0xc67178f2</span>\n];\n\n<span class=\"hljs-keyword\">const</span> mapW = (<span class=\"hljs-attr\">array64</span>: <span class=\"hljs-built_in\">number</span>[], <span class=\"hljs-title class_\">Mi</span>: <span class=\"hljs-built_in\">string</span>[]): <span class=\"hljs-built_in\">number</span>[] =&gt; {\n  <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">let</span> i = <span class=\"hljs-number\">0</span>; i &lt; <span class=\"hljs-number\">64</span>; i++) {\n    <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">hexNum</span>: <span class=\"hljs-built_in\">number</span> = <span class=\"hljs-built_in\">parseInt</span>(<span class=\"hljs-title class_\">Mi</span>[i], <span class=\"hljs-number\">16</span>);\n\n    <span class=\"hljs-keyword\">if</span> (i &lt; <span class=\"hljs-number\">16</span>) {\n      array64[i] = hexNum;\n      <span class=\"hljs-keyword\">continue</span>;\n    }\n    <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">tmp</span>: <span class=\"hljs-built_in\">number</span> = <span class=\"hljs-title function_\">lowerSigma1</span>(array64[i - <span class=\"hljs-number\">2</span>]) + array64[i - <span class=\"hljs-number\">7</span>] + <span class=\"hljs-title function_\">lowerSigma0</span>(array64[i - <span class=\"hljs-number\">15</span>]) + array64[i - <span class=\"hljs-number\">16</span>];\n\n    array64[i] = (tmp &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n  }\n  <span class=\"hljs-keyword\">return</span> array64;\n};\n\n<span class=\"hljs-comment\">// メインの関数</span>\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">const</span> computeHash = (<span class=\"hljs-attr\">M</span>: <span class=\"hljs-built_in\">string</span>): <span class=\"hljs-function\"><span class=\"hljs-params\">string</span> =&gt;</span> {\n  <span class=\"hljs-comment\">// ブロックごとにハッシュ値が格納される配列</span>\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">H</span>: <span class=\"hljs-built_in\">number</span>[] = [<span class=\"hljs-number\">0x6a09e667</span>, <span class=\"hljs-number\">0xbb67ae85</span>, <span class=\"hljs-number\">0x3c6ef372</span>, <span class=\"hljs-number\">0xa54ff53a</span>, <span class=\"hljs-number\">0x510e527f</span>, <span class=\"hljs-number\">0x9b05688c</span>, <span class=\"hljs-number\">0x1f83d9ab</span>, <span class=\"hljs-number\">0x5be0cd19</span>];\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">paddedString</span>: <span class=\"hljs-built_in\">string</span> = <span class=\"hljs-title function_\">padding</span>(M);\n  <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">dividedM</span>: <span class=\"hljs-built_in\">string</span>[] = <span class=\"hljs-title function_\">divideM</span>(paddedString);\n\n  <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">let</span> i = <span class=\"hljs-number\">0</span>; i &lt; dividedM.<span class=\"hljs-property\">length</span>; i++) {\n    <span class=\"hljs-keyword\">const</span> <span class=\"hljs-title class_\">Mi</span>: <span class=\"hljs-title class_\">RegExpMatchArray</span> | <span class=\"hljs-literal\">null</span> = dividedM[i].<span class=\"hljs-title function_\">match</span>(<span class=\"hljs-regexp\">/.{8}/g</span>); <span class=\"hljs-comment\">// 64bytesのブロックをさらに4byteずつ刻んでいく</span>\n\n    <span class=\"hljs-keyword\">if</span> (!<span class=\"hljs-title class_\">Mi</span>) <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Error</span>(<span class=\"hljs-string\">&quot;Failed to divide dividedM&quot;</span>);\n    <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">W</span>: <span class=\"hljs-built_in\">number</span>[] = <span class=\"hljs-title function_\">mapW</span>(<span class=\"hljs-title class_\">Array</span>(<span class=\"hljs-number\">64</span>), <span class=\"hljs-title class_\">Mi</span>);\n    <span class=\"hljs-keyword\">let</span> a, b, c, d, e, f, g, h;\n\n    [a, b, c, d, e, f, g, h] = [...H];\n    <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">let</span> t = <span class=\"hljs-number\">0</span>; t &lt; <span class=\"hljs-number\">64</span>; t++) {\n      <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">T1</span>: <span class=\"hljs-built_in\">number</span> = ((h + <span class=\"hljs-title function_\">upperSigma1</span>(e) + <span class=\"hljs-title function_\">ch</span>(e, f, g) + K[t] + W[t]) &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n      <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">T2</span>: <span class=\"hljs-built_in\">number</span> = ((<span class=\"hljs-title function_\">upperSigma0</span>(a) + <span class=\"hljs-title function_\">maj</span>(a, b, c)) &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n\n      h = g;\n      g = f;\n      f = e;\n      e = ((d + <span class=\"hljs-variable constant_\">T1</span>) &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n      d = c;\n      c = b;\n      b = a;\n      a = ((<span class=\"hljs-variable constant_\">T1</span> + <span class=\"hljs-variable constant_\">T2</span>) &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n    }\n    H[<span class=\"hljs-number\">0</span>] = ((a + H[<span class=\"hljs-number\">0</span>]) &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n    H[<span class=\"hljs-number\">1</span>] = ((b + H[<span class=\"hljs-number\">1</span>]) &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n    H[<span class=\"hljs-number\">2</span>] = ((c + H[<span class=\"hljs-number\">2</span>]) &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n    H[<span class=\"hljs-number\">3</span>] = ((d + H[<span class=\"hljs-number\">3</span>]) &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n    H[<span class=\"hljs-number\">4</span>] = ((e + H[<span class=\"hljs-number\">4</span>]) &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n    H[<span class=\"hljs-number\">5</span>] = ((f + H[<span class=\"hljs-number\">5</span>]) &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n    H[<span class=\"hljs-number\">6</span>] = ((g + H[<span class=\"hljs-number\">6</span>]) &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n    H[<span class=\"hljs-number\">7</span>] = ((h + H[<span class=\"hljs-number\">7</span>]) &amp; <span class=\"hljs-number\">0xffffffff</span>) &gt;&gt;&gt; <span class=\"hljs-number\">0</span>;\n  }\n\n  <span class=\"hljs-keyword\">let</span> <span class=\"hljs-attr\">result</span>: <span class=\"hljs-built_in\">string</span> = <span class=\"hljs-string\">&quot;&quot;</span>;\n\n  H.<span class=\"hljs-title function_\">map</span>(<span class=\"hljs-function\"><span class=\"hljs-params\">b</span> =&gt;</span> {\n    <span class=\"hljs-keyword\">let</span> <span class=\"hljs-attr\">hashString</span>: <span class=\"hljs-built_in\">string</span> = b.<span class=\"hljs-title function_\">toString</span>(<span class=\"hljs-number\">16</span>);\n    <span class=\"hljs-keyword\">if</span>(hashString.<span class=\"hljs-property\">length</span> &lt; <span class=\"hljs-number\">8</span>) {\n      <span class=\"hljs-keyword\">const</span> <span class=\"hljs-attr\">extraZeros</span>: <span class=\"hljs-built_in\">string</span> = <span class=\"hljs-title class_\">Array</span>(<span class=\"hljs-number\">8</span> - hashString.<span class=\"hljs-property\">length</span>).<span class=\"hljs-title function_\">fill</span>(<span class=\"hljs-number\">0</span>).<span class=\"hljs-title function_\">join</span>(<span class=\"hljs-string\">&#x27;&#x27;</span>);\n      hashString = extraZeros + hashString;\n    }\n    result += hashString;\n  });\n  <span class=\"hljs-keyword\">if</span>(result.<span class=\"hljs-property\">length</span> !== <span class=\"hljs-number\">64</span>) <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> <span class=\"hljs-title class_\">Error</span>(<span class=\"hljs-string\">&quot;Hash result is not 32bytes&quot;</span>);\n\n  <span class=\"hljs-keyword\">return</span> result;\n};\n</code></pre>\n<p>最適化とは程遠いコードですが、ひとつアルゴリズムを理解できたというのは嬉しいですね。</p>\n<h2>参考文献</h2>\n<p><a href=\"https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.180-4.pdf\">https://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.180-4.pdf</a></p>\n<p><a href=\"https://qiita.com/tnakagawa/items/6321472098a2b73836ab#sha256%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E8%A8%88%E7%AE%97sha-256-hash-computation\">https://qiita.com/tnakagawa/items/6321472098a2b73836ab#sha256ハッシュ計算sha-256-hash-computation</a></p>\n<p><a href=\"https://www.air-h.jp/articles/emopro/%E3%80%90go%E3%80%91%E6%9A%97%E5%8F%B7%E5%8C%96%E3%82%84%E3%83%8F%E3%83%83%E3%82%B7%E3%83%A5%E5%8C%96%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E8%80%83%E3%81%88%E3%82%8B%E3%81%A4%E3%81%84%E3%81%A7%E3%81%AB/\">https://www.air-h.jp/articles/emopro/【go】暗号化やハッシュ化について考えるついでに/</a></p>\n"}